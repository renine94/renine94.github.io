---
layout: single

header:
  teaser: /assets/images/logo/django.png
  overlay_image: /assets/images/logo/django.png
  overlay_filter: linear-gradient(rgba(255, 0, 0, 0.5), rgba(0, 255, 255, 0.5))
  caption: "Photo credit: [**Unsplash**](https://unsplash.com)"
  actions:
    - label: "Github"
      url: "https://github.com/renine94"

title: "[Django] ORM ì—¬ëŸ¬ê°€ì§€ ì‚¬ìš©ë²• ì •ë¦¬ (1)"
excerpt: "ğŸš€ filter, annotation, group by, gte, lte, ..."

categories: django
tag: [django, orm, annotation]

toc: true
toc_label: "ğŸ“• ëª©ì°¨"
toc_icon: "null"
toc_sticky: true

sidebar:
  nav: "docs"
---


# SQLê³¼ django ORM

## ì°¸ê³ ë¬¸ì„œ

[Making queries/Django documentation/Django](https://docs.djangoproject.com/en/2.2/topics/db/queries/#making-queries)

[QuerySet API reference/Django documentation/Django](https://docs.djangoproject.com/en/2.2/ref/models/querysets/#queryset-api-reference)

[Aggregation/Django documentation/Django](https://docs.djangoproject.com/en/2.2/topics/db/aggregation/#aggregation)

## **ê¸°ë³¸ ì¤€ë¹„ ì‚¬í•­**


- django app
    - `django_extensions` ì„¤ì¹˜
    - `users` app ìƒì„±
    - csv íŒŒì¼ì— ë§ì¶° `models.py` ì‘ì„± ë° migrate

            $ python manage.py sqlmigrate users 0001

- `db.sqlite3` í™œìš© ë° ë°ì´í„° ë°˜ì˜
    - `sqlite3` ì‹¤í–‰

            $ ls
            db.sqlite3 manage.py ...
            $ sqlite3 db.sqlite3

    - csv íŒŒì¼ data ë¡œë“œ

            sqlite > .tables
            auth_group                  django_admin_log
            auth_group_permissions      django_content_type
            auth_permission             django_migrations
            auth_user                   django_session
            auth_user_groups            auth_user_user_permissions
            users_user
            sqlite > .mode csv
            sqlite > .import users.csv users_user
            sqlite > SELECT COUNT(*) FROM users_user;
            100

- í™•ì¸
    - sqlite3ì—ì„œ ìŠ¤í‚¤ë§ˆ í™•ì¸

            sqlite > .schema users_user

## **ë¬¸ì œ**

> ì•„ë˜ì˜ ë¬¸ì œë“¤ì„ sqlë¬¸ê³¼ ëŒ€ì‘ë˜ëŠ” ormì„ ì‘ì„± í•˜ì„¸ìš”.

### Table ìƒì„±

- django

```python
# django
class User(models.Model):
   first_name = models.CharField(max_length=10)
   last_name = models.CharField(max_length=10)
   age = models.IntegerField()
   country = models.CharField(max_length=10)
   phone = models.CharField(max_length=15)
   balance = models.IntegerField()

# python manage.py makemigrations
# python manage.py migrate
```

- SQL
    - sql.sqlite3ì— ë™ì¼í•˜ê²Œ í…Œì´ë¸” ìƒì„±

```sql
--sql
```

### ê¸°ë³¸ CRUD ë¡œì§

1. ëª¨ë“  user ë ˆì½”ë“œ ì¡°íšŒ

```python
# orm
users = User.objects.all()
type(users)
#=> django.db.models.query.QuerySet
print(users.query)
# querysetë§Œ sqlë¬¸ ì¶œë ¥ ê°€ëŠ¥
#=> SELECT "users_user"."id", "users_user"."first_name", "users_user"."last_name", "users_user"."age", "users_user"."country", "users_user"."phone", "users_user"."balance" FROM "users_user"
```

```sql
-- sql
SELECT * FROM users_user;

id | first_name | last_name | age | country | phone | balance
1 | ì •í˜¸ | ìœ  | 40 | ì „ë¼ë¶ë„ | 016-7280-2855 | 370
...
```

2. user ë ˆì½”ë“œ ìƒì„±

```python
# orm
User.objects.create(
   first_name='êµ¬ë¦„',
   last_name='ê¹€',
   age=100,
   country='ì œì£¼ë„',
   phone='010-1234-1234',
   balance=10000000000000
)
```

```sql
-- sql
INSERT INTO users_user ('first_name', 'last_name', 'age', 'country', 'phone', 'balance')
VALUES ('ê·¼ì œ', 'ì„±', 80, 'ì„œìš¸', '011-123-1324', 999999999999999999999);
```

* í•˜ë‚˜ì˜ ë ˆì½”ë“œë¥¼ ë¹¼ê³  ì‘ì„± í›„ `NOT NULL` constraint ì˜¤ë¥˜ë¥¼ ormê³¼ sqlì—ì„œ ëª¨ë‘ í™•ì¸ í•´ë³´ì„¸ìš”.

```python
# orm
IntegrityError: NOT NULL constraint failed: users_user.age
```

```sql
-- sql
Error: NOT NULL constraint failed: users_user.last_name
```

3. í•´ë‹¹ user ë ˆì½”ë“œ ì¡°íšŒ

```python
# orm
User.objects.get(id=100)
#=> <User: User object (100)>
```

* `get` ì€ ì¿¼ë¦¬ ê²°ê³¼ê°€ ë°˜ë“œì‹œ í•˜ë‚˜ì—¬ì•¼ í•œë‹¤. ì´ì™¸ì—ëŠ” ëª¨ë‘ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤.

```python
User.objects.get(last_name='ê¹€')
# MultipleObjectsReturned: get() returned more than one User -- it returned 24!
User.objects.get(id=1000)
# DoesNotExist: User matching query does not exist.
```

```sql
-- sql
SELECT * FROM users_user
WHERE id = 100;
```

4. í•´ë‹¹ user ë ˆì½”ë“œ ìˆ˜ì •

```python
# orm
user = User.objects.get(id=100)
user.last_name = 'ì„±'
user.save()
```

```sql
-- sql
UPDATE users_user
SET last_name='ìµœ'
WHERE id = 100;
```

5. í•´ë‹¹ user ë ˆì½”ë“œ ì‚­ì œ

```python
# orm
User.objects.get(id=101).delete()
```
   ```sql
-- sql
DELETE FROM users_user
WHERE id = 102;
   ```

### ì¡°ê±´ì— ë”°ë¥¸ ì¿¼ë¦¬ë¬¸

1. ì „ì²´ ì¸ì› ìˆ˜

```python
# orm
User.objects.count()
```

   ```sql
-- sql
SELECT COUNT(*) FROM users_user;
COUNT(id)
100
   ```

2. ë‚˜ì´ê°€ 30ì¸ ì‚¬ëŒì˜ ì´ë¦„

```python
# orm
User.objects.filter(age=30)
#=> <QuerySet [<User: User object (5)>, <User: User object (57)>, <User: User object (60)>]>

User.objects.filter(age=30).values('first_name')
#=> <QuerySet [{'first_name': 'ì˜í™˜'}, {'first_name': 'ë³´ëŒ'}, {'first_name': 'ì€ì˜'}]>

type(User.objects.filter(age=30).values('first_name')[0])
#=> dict

print(User.objects.filter(age=30).values('first_name').query)
#=> SELECT "users_user"."first_name" FROM "users_user" WHERE "users_user"."age" = 30
```

```sql
-- sql
SELECT first_name FROM users_user
WHERE age = 30;
first_name
ì˜í™˜
ë³´ëŒ
ì€ì˜
```

3. ë‚˜ì´ê°€ 30ì‚´ ì´ìƒì¸ ì‚¬ëŒì˜ ì¸ì› ìˆ˜

> ëŒ€ì†Œê´€ê³„
>
> `__gte` : >=
>
> `__gt` : >
>
> `__lte` : <=
>
> `__lt` : <

```python
# orm
User.objects.filter(age__gte=30)
print(User.objects.filter(age__gte=30).query)
# SELECT "users_user"."id", "users_user"."first_name", "users_user"."last_name", "users_user"."age", "users_user"."country", "users_user"."phone", "users_user"."balance" FROM "users_user" WHERE "users_user"."age" >= 30
User.objects.filter(age__gte=30).count()
```

```sql
-- sql
SELECT COUNT(*) FROM users_user
WHERE age >= 30;

COUNT(*)
43
```

4. ë‚˜ì´ê°€ 30ì´ë©´ì„œ ì„±ì´ ê¹€ì”¨ì¸ ì‚¬ëŒì˜ ì¸ì› ìˆ˜

```python
# orm -1
User.objects.filter(age=30).filter(last_name='ê¹€').count()
# orm -2
User.objects.filter(age=30, last_name='ê¹€').count()
# query
print(User.objects.filter(age=30).filter(last_name='ê¹€').query)
# => SELECT "users_user"."id", "users_user"."first_name", "users_user"."last_name", "users_user"."age", "users_user"."country", "users_user"."phone", "users_user"."balance" FROM "users_user" WHERE ("users_user"."age" = 30 AND "users_user"."last_name" = ê¹€)
```

```sql
-- sql
SELECT COUNT(*) FROM users_user
WHERE age = 30 AND last_name = 'ê¹€';
```

5. ì§€ì—­ë²ˆí˜¸ê°€ 02ì¸ ì‚¬ëŒì˜ ì¸ì› ìˆ˜

> https://docs.djangoproject.com/en/2.2/topics/db/queries/#escaping-percent-signs-and-underscores-in-like-statements
>
> ```
> iexact, contains, icontains, startswith, istartswith, endswith, iendswith
> ```

```python
# orm
User.objects.filter(phone__startswith='02-').count()

# query
print(User.objects.filter(phone__startswith='02-').query)
#=> SELECT "users_user"."id", "users_user"."first_name", "users_user"."last_name", "users_user"."age", "users_user"."country", "users_user"."phone", "users_user"."balance" FROM "users_user" WHERE "users_user"."phone" LIKE 02-% ESCAPE '\'
```

```sql
-- sql
SELECT COUNT(*) FROM users_user
WHERE phone LIKE '02-%';
```

6. ê±°ì£¼ ì§€ì—­ì´ ê°•ì›ë„ì´ë©´ì„œ ì„±ì´ í™©ì”¨ì¸ ì‚¬ëŒì˜ ì´ë¦„

```python
# orm
```

```sql
-- sql
```



### ì •ë ¬ ë° LIMIT, OFFSET

1. ë‚˜ì´ê°€ ë§ì€ ì‚¬ëŒ 10ëª…(ë‚´ë¦¼ì°¨ìˆœ)

```python
# orm
User.objects.order_by('-age')[:10]

# query
print(User.objects.order_by('-age')[:10].query)
#=> SELECT "users_user"."id", "users_user"."first_name", "users_user"."last_name", "users_user"."age", "users_user"."country", "users_user"."phone", "users_user"."balance" FROM "users_user" ORDER BY "users_user"."age" DESC  LIMIT 10
```

```sql
-- sql
SELECT * FROM users_user
ORDER BY age DESC
LIMIT 10;

id | first_name | last_name | age | country | phone | balance
1 | ì •í˜¸ | ìœ  | 40 | ì „ë¼ë¶ë„ | 016-7280-2855 | 370
4 | ë¯¸ê²½ | ì¥ | 40 | ì¶©ì²­ë‚¨ë„ | 011-9079-4419 | 250000
28 | ì„±í˜„ | ë°• | 40 | ê²½ìƒë‚¨ë„ | 011-2884-6546 | 580000
```

2. ì”ì•¡ì´ ì ì€ ì‚¬ëŒ 10ëª… (ì˜¤ë¦„ì°¨ìˆœ)

```python
# orm
User.objects.order_by('balance')[:10]
```

```sql
-- sql
SELECT * FROM users_user
ORDER BY balance ASC
LIMIT 10;
```

3. ì„±, ì´ë¦„ ë‚´ë¦¼ì°¨ìˆœ ìˆœìœ¼ë¡œ 5ë²ˆì§¸ ìˆëŠ” ì‚¬ëŒ

```python
# orm
User.objects.order_by('-last_name', '-first_name')[4]
#=>  <User: User object (67)>
```

```sql
-- sql
SELECT * FROM users_user
ORDER BY last_name DESC, first_name DESC
LIMIT 1 OFFSET 4;

id | first_name | last_name | age | country | phone | balance
67 | ë³´ëŒ | í—ˆ | 28 | ì¶©ì²­ë¶ë„ | 016-4392-9432 | 82000
```



### í‘œí˜„ì‹

> í‘œí˜„ì‹ì„ ìœ„í•´ì„œëŠ” [aggregate]([https://docs.djangoproject.com/en/2.2/topics/db/aggregation/](https://docs.djangoproject.com/en/2.2/topics/db/aggregation/)) ë¥¼ ì•Œì•„ì•¼í•œë‹¤.

1. ì „ì²´ í‰ê·  ë‚˜ì´

```python
# orm
from django.db.models import Avg
User.objects.aggregate(Avg('age'))
#=> {'age__avg': 28.23}
```

```sql
-- sql
SELECT AVG(age) FROM users_user;
AVG(age)
28.23
```

2. ê¹€ì”¨ì˜ í‰ê·  ë‚˜ì´

```python
# orm
from django.db.models import Avg
User.objects.filter(last_name='ê¹€').aggregate(Avg('age'))
```

   ```sql
-- sql
SELECT AVG(age) FROM users_user
WHERE last_name = 'ê¹€';
   ```

3. ê³„ì¢Œ ì”ì•¡ ì¤‘ ê°€ì¥ ë†’ì€ ê°’

```python
# orm
from django.db.models import Max
User.objects.aggregate(Max('balance'))
```

   ```sql
-- sql
SELECT MAX(balance) FROM users_user;
   ```

4. ê³„ì¢Œ ì”ì•¡ ì´ì•¡

```python
# orm
from django.db.models import Sum
User.objects.aggregate(Sum('balance'))
```

```sql
   -- sql
   SELECT SUM(balance) FROM users_user;
```



### Group by

> annotateëŠ” ê°œë³„ itemì— ì¶”ê°€ í•„ë“œë¥¼ êµ¬ì„±í•œë‹¤.
>
> ì¶”í›„ 1:N ê´€ê³„ì—ì„œ í™œìš©ëœë‹¤.

1. ì§€ì—­ë³„ ì¸ì› ìˆ˜

ORM

```python
# orm
User.objects.values('country')

# <QuerySet [{'country': 'ì „ë¼ë¶ë„'}, {'country': 'ê²½ìƒë‚¨ë„'}, {'country': 'ì „ë¼ë‚¨ë„'}, ...

from django.db.models import Count
User.objects.values('country').annotate(Count('country'))

# <QuerySet [{'country': 'ê°•ì›ë„', 'country__count': 14}, {'country': 'ê²½ê¸°ë„', 'country__count': 9}, {'country': 'ê²½ìƒë‚¨ë„', 'country__count': 9}, {'country': 'ê²½ìƒë¶ë„', 'country__count': 15}, {'country': 'ì „ë¼ë‚¨ë„', 'country__count': 10}, {'country': 'ì „ë¼ë¶ë„', 'country__count': 11}, {'country': 'ì œì£¼íŠ¹ë³„ìì¹˜ë„', 'country__count': 9}, {'country': 'ì¶©ì²­ë‚¨ë„', 'country__count': 9}, {'country': 'ì¶©ì²­ë¶ë„', 'country__count': 14}]>
```

SQL
```sql
SELECT country, COUNT(country) FROM users_user
GROUP BY country;

country | COUNT(country)
ê°•ì›ë„ | 14
ê²½ê¸°ë„ | 9
ê²½ìƒë‚¨ë„ | 9
ê²½ìƒë¶ë„ | 15
ì „ë¼ë‚¨ë„ | 10
ì „ë¼ë¶ë„ | 11
ì œì£¼íŠ¹ë³„ìì¹˜ë„ | 9
ì¶©ì²­ë‚¨ë„ | 9
ì¶©ì²­ë¶ë„ | 14
```
